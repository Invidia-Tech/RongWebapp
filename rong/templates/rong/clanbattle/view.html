{% extends 'rong/layout.html' %}
{% load unit_icons %}
{% load clan_battle %}
{% load humanize %}

{% load static %}
{% load bootstrap4 %}

{% block extra_js %}
{% endblock %}

{% block extra_css %}
{% endblock %}

{% block title %}{{ battle.name }} - {{ battle.clan.name }}{% endblock %}

{% block content %}
    <div class="w-100 text-center mb-3"><h2 class="display-2">{{ battle.name }}</h2></div>
    {% can_manage request.user battle as manageable %}
    {% if battle.in_progress %}
        <div class="jumbotron text-center position-relative">
            <div class="row align-items-center">
                <div class="col-md-4 text-center">
                    {% enemy_icon battle.current_boss_icon alt=battle.current_boss_name %}
                    <p>
                        Lap {{ battle.current_lap }} {{ battle.current_boss_name }}<br>
                        {{ battle.current_hp|intcomma }} HP left<br>
                        {{ battle.hits_today|format_hits }}/{{ battle.total_daily_hits|format_hits }} clan hits today
                        {% if battle.damage_dealt_today %}
                            <br>{{ battle.damage_dealt_today|intcomma }} damage dealt today
                            {% if battle.bosses_killed_today %}
                                <br>{{ battle.bosses_killed_today }} bosses killed today
                            {% endif %}
                        {% endif %}
                    </p>
                </div>
                <div class="col-md-8 text-left">
                    <div class="row">
                        <div class="col">Day {{ battle.current_day }}/{{ battle.total_days }}</div>
                    </div>
                    <div class="row">
                        <div class="col">
                            {% if battle.next_reset < battle.end_time %}
                                Reset in <b>{{ battle.next_reset|timeuntil }}</b>
                            {% else %}
                                Ends in <b>{{ battle.end_time|timeuntil }}</b>
                            {% endif %}
                        </div>
                    </div>
                    <hr>
                    <div class="row">
                        <div class="col"><p>Placeholder for plans once implemented</p></div>
                    </div>
                </div>
            </div>
            <hr>
            <div class="row align-items-start">
                <div class="col-md-6">
                    <div class="row header align-items-center">
                        <div class="col-md-8 text-left"><h4>Clan Hit Log</h4></div>
                        <div class="col-md-4"><a href="{% url 'rong:cb_list_hits' battle.slug %}"
                                                 class="btn btn-primary">Details</a></div>
                    </div>
                    <div class="row">
                        <div class="col hitlog">
                            {% if hits %}
                                {% for hit in hits %}
                                    <div class="hit">
                                        <div class="info"><b>{{ hit.displayed_username }}</b> attacked
                                            <b>{% boss_name battle hit %}</b> for
                                            <b>{{ hit.damage|intcomma }}</b> damage{% if hit.killing_blow %}
                                                (Victory){% endif %}
                                        </div>
                                        <div class="timestamp">XX hours ago</div>
                                    </div>
                                {% endfor %}
                            {% else %}
                                <div class="d-flex align-items-center h-100">
                                    <p class="w-100"><i>No hits registered... yet!</i></p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% if in_clan %}
                    <div class="col-md-6">
                        <div class="row header align-items-center">
                            <div class="col-md-4 text-left"><h4>My Hits</h4></div>
                            <div class="col-md-4">{% user_hits_today battle request.user %} hits
                                used, {% user_hits_left_today battle request.user %} left
                            </div>
                            <div class="col-md-4"><a href="#" class="btn btn-primary">Personal Logs</a></div>
                        </div>
                        <div class="row">
                            <div class="col hitlog">
                                {% if myhits %}
                                    {% for hit in myhits %}
                                        <div class="hit">
                                            <div class="info">You attacked <b>{% boss_name battle hit %}</b> for
                                                <b>{{ hit.damage|intcomma }}</b> damage{% if hit.killing_blow %}
                                                    (Victory){% endif %}
                                            </div>
                                            <div class="timestamp">XX hours ago</div>
                                        </div>
                                    {% endfor %}
                                {% else %}
                                    <div class="d-flex align-items-center h-100">
                                        <p class="w-100"><i>No hits registered... yet!</i></p>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>

    {% elif battle.ended %}
        <p>This CB ended {{ battle.end_time|naturaltime }}.</p>
        <a href="{% url 'rong:cb_list_hits' battle.slug %}" class="btn btn-primary">Hit Log</a>
    {% else %}
        <p>This CB starts in {{ battle.start_time|naturaltime }}.</p>
    {% endif %}
    <hr>
    {% if battle.in_progress or battle.ended %}
        {% if manageable %}
            <h2>Stats</h2>
            <ul id="tabs" class="nav nav-tabs">
                <li class="nav-item"><a href="" data-target="#hits-used" data-toggle="tab"
                                        class="nav-link small active">Hits Used</a></li>
                <li class="nav-item"><a href="" data-target="#dps-daily" data-toggle="tab" class="nav-link small">DPS
                    (Daily)</a></li>
                <li class="nav-item"><a href="" data-target="#score-daily" data-toggle="tab" class="nav-link small">Score
                    (Daily)</a></li>
            </ul>
            <br>
            <div id="tabsContent" class="tab-content">
                <div id="hits-used" class="tab-pane active show">
                    <table class="dt w-100 table dt-noPaging stats-table" id="hitsUsedTable">
                        <thead>
                        <tr>
                            <th>Player</th>
                            {% for day in battle.day_range %}
                                <th>Day {{ day }}</th>
                            {% endfor %}
                        </tr>
                        </thead>
                        <tbody>
                        {% for player in battle.hit_stats %}
                            <tr>
                                <td>{{ player.member.user_display_name }}</td>
                                {% for day in player.days %}
                                    {% day_reached battle forloop.counter as active %}
                                    {% if active %}
                                        <td data-hits="{{ day.hits|format_hits }}">{{ day.hits|format_hits }}</td>
                                    {% else %}
                                        <td>0</td>
                                    {% endif %}
                                {% endfor %}
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="dps-daily" class="tab-pane">
                    <table class="dt w-100 table dt-noPaging stats-table daily-table" id="dpsDailyTable">
                        <thead>
                        <tr>
                            <th>Player</th>
                            {% for day in battle.day_range %}
                                <th>Day {{ day }}</th>
                            {% endfor %}
                            <th>Total DMG</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for player in battle.hit_stats %}
                            <tr>
                                <td class="name">{{ player.member.user_display_name }}</td>
                                {% for day in player.days %}
                                    {% day_reached battle forloop.counter as active %}
                                    {% if active %}
                                        <td data-sort="{{ day.damage }}" class="day">
                                            <div class="day-total">{{ day.damage|intcomma }}</div>
                                            <div class="hits">
                                                {% for hit in day.hit_damage %}
                                                    <div>{{ hit|smallhit }}</div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                {% endfor %}
                                <td data-sort="{{ player.total_damage }}" class="total">{{ player.total_damage|intcomma }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
                <div id="score-daily" class="tab-pane">
                    <table class="dt w-100 table dt-noPaging stats-table daily-table" id="scoreDailyTable">
                        <thead>
                        <tr>
                            <th>Player</th>
                            {% for day in battle.day_range %}
                                <th>Day {{ day }}</th>
                            {% endfor %}
                            <th>Total Score</th>
                        </tr>
                        </thead>
                        <tbody>
                        {% for player in battle.hit_stats %}
                            <tr>
                                <td class="name">{{ player.member.user_display_name }}</td>
                                {% for day in player.days %}
                                    {% day_reached battle forloop.counter as active %}
                                    {% if active %}
                                        <td data-sort="{{ day.score }}" class="day">
                                            <div class="day-total">{{ day.score|intcomma }}</div>
                                            <div class="hits">
                                                {% for hit in day.hit_score %}
                                                    <div>{{ hit|smallhit }}</div>
                                                {% endfor %}
                                            </div>
                                        </td>
                                    {% else %}
                                        <td></td>
                                    {% endif %}
                                {% endfor %}
                                <td data-sort="{{ player.total_score }}" class="total">{{ player.total_score|intcomma }}</td>
                            </tr>
                        {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
            <hr>
        {% endif %}
    {% endif %}
    <h2>Boss Info</h2>
    <table class="table w-100">
        <thead>
        <tr>
            <th></th>
            {% for boss in battle.boss_list %}
                <th class="text-center">
                    <img src="{% static 'rong/images/enemies/' %}{{ boss.icon }}.png"/><br>
                    {{ boss.name }}
                </th>
            {% endfor %}
        </tr>
        </thead>
        <tbody>
        {% for phase in battle.bosses.all %}
            <tr>
                <th>Phase {{ forloop.counter }}<br>
                    {% if not phase.lap_to %}
                        Lap {{ phase.lap_from }}+
                    {% elif phase.lap_from == phase.lap_to %}
                        Lap {{ phase.lap_from }}
                    {% else %}
                        Laps {{ phase.lap_from }}-{{ phase.lap_to }}
                    {% endif %}</th>
                {% for boss in phase.boss_list %}
                    <td class="text-center">
                        Lv{{ boss.level }}<br>
                        HP {{ boss.hp|intcomma }}<br>
                        {{ boss.pdef }} PDEF / {{ boss.mdef }} MDEF
                    </td>
                {% endfor %}
            </tr>
        {% endfor %}
        </tbody>
    </table>
{% endblock %}
